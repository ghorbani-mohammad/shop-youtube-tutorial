services:
  shop_db:
    container_name: shop_db
    image: postgres:14.3-alpine  
    volumes:    
      - shop_db:/var/lib/postgresql/data  
    env_file:    
      - .env

  shop_api:  
    container_name: shop_api 
    build: .
    depends_on:    
      - shop_db  
    volumes:    
      - .:/app  
    ports:    
      - 9022:80  
    command: ["python", "/app/shop/manage.py", "runserver", "0:80"]  
    env_file:    
      - .env

  shop_redis:
    container_name : shop_redis
    image: redis:6.2-alpine

  shop_beat:
    container_name: shop_beat
    build: .
    working_dir: /app/shop
    command: ["celery", "-A", "shop", "beat", "-l", "info"]
    volumes:
      - .:/app
    depends_on:
      - shop_db
      - shop_redis    

  shop_worker:
    container_name: shop_worker
    build: .
    working_dir: /app/shop
    command: ["celery", "-A", "shop", "worker", "-l", "info"]
    volumes:
      - .:/app
      - ./media:/app/shop/media
    depends_on:
      - shop_db
      - shop_redis
  
  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.3.1
    container_name: elasticsearch
    environment:
      - xpack.security.enabled=false
      - discovery.type=single-node
    volumes:
      - elasticsearch-data:/usr/share/elasticsearch/data
    ports:
      - 9200:9200

volumes:
  shop_db:
  elasticsearch-data: